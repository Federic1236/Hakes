<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hakes</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS STYLES --- */
        body { 
            font-family: 'Inter', sans-serif; 
            padding: 20px; 
            text-align: center;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            background-color: #f0f0f0;
        }
        
        /* Login Box */
        #login-box { 
            border: 1px solid #ccc; 
            padding: 20px; 
            max-width: 400px; 
            margin: 50px auto 0;
            border-radius: 15px; 
            background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        input[type="password"], input[type="text"], button { 
            padding: 10px; 
            margin: 5px; 
            width: 80%; 
            box-sizing: border-box;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        button {
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            font-weight: bold;
        }
        button:hover { background-color: #0056b3; }
        
        /* Private Content (Success) */
        #private-content { 
            display: none; 
            border: 2px solid green; 
            padding: 30px; 
            max-width: 800px;
            margin: 20px auto;
            text-align: left;
            background-color: #e9ffe9;
            border-radius: 8px;
        }
        
        /* Denial Screen */
        #denial-screen {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 1000;
        }
        #denial-video {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            opacity: 0.8;
        }

        /* FOCUS LOSS EASTER EGG (scary.png) */
        #focus-effect {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 10000;
        }
        #focus-effect img {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            object-fit: cover; 
        }
        
        /* Utilities */
        .error { color: red; margin-top: 10px; font-weight: bold; }
        .success { color: green; margin-top: 10px; font-weight: bold; }
        .editable { border: 1px dashed blue; padding: 5px; cursor: text; background: white; }
        
        /* Chat Section */
        #chat-section {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        #comments-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
        }
        .comment-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #ddd;
        }
        .comment-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

    <div id="denial-screen">
        <video id="denial-video" src="./videos/denial-video.mp4" loop playsinline></video>
        
        <audio id="denial-sound-1" src="./audio/your_loop_sound.mp3" loop></audio> 
        <audio id="denial-sound-2" src="./audio/your_loop_sound2.mp3" loop></audio> 
        <audio id="denial-sound-3" src="./audio/your_loop_sound3.mp3" loop></audio> </div>

    <div id="focus-effect">
        <img src="./images/scary.png" alt="Do not leave...">
    </div>

    <div id="login-box">
        <h2>Stiamo sistemando il sito!</h2>
        <p>Inserisci il nome e password dell'account.</p>
        
        <input type="text" id="user-name-input" placeholder="Nome">
        <input type="password" id="user-pass" placeholder="Password">
        <button onclick="attemptLogin()">Invia</button>
        <p id="message-area"></p>
    </div>

    <div id="private-content">
        <h1 id="private-title" contenteditable="false">âœ… Secure Access Granted!</h1>
        <p id="private-text" contenteditable="false">You have successfully logged in.</p>
        
        <hr>
        
        <div id="chat-section">
            <h3>ðŸ’¬ Admin Message:</h3>
            <p id="admin-message">Loading message...</p>
            
            <hr>
            
            <h3>Comments</h3>
            <div id="comments-list">
                <div>Loading comments...</div> 
            </div>

            <div style="margin-top: 15px;">
                <input type="text" id="new-comment-input" placeholder="Type your comment..." style="width: 100%;">
                <button onclick="postComment()" style="width: 100%; margin-top: 5px;">Post Comment</button>
            </div>
        </div>
        
        <button onclick="logout()" style="margin-top: 20px; background-color: #666;">Logout</button>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const VERCEL_API_BASE_URL = 'https://hakes.vercel.app'; 
        
        const SUPABASE_URL = 'https://gfrcflagflhjlrsxabra.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmcmNmbGFnZmxoamxyc3hhYnJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTUwMTEsImV4cCI6MjA4MTQ3MTAxMX0.eetI23nvTAkKJPqxGx4JvikJ1DkXSnVYyZhFVli4tH0'; 

        // SAFE SUPABASE INITIALIZATION 
        let supabaseClient = null;
        if (window.supabase) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            console.error("Supabase library not loaded. Check connection.");
        }

        // --- 2. STATE VARIABLES ---
        let currentUser = null; 
        let accessGranted = false; 
        let hasLeft = false;      
        let effectActive = false; 

        // --- 3. DOM REFERENCES ---
        const effectScreen = document.getElementById('focus-effect');
        const denialVideo = document.getElementById('denial-video');
        
        // Grab all three sounds
        const denialSound1 = document.getElementById('denial-sound-1');
        const denialSound2 = document.getElementById('denial-sound-2');
        const denialSound3 = document.getElementById('denial-sound-3'); // NEW REFERENCE
        
        // --- 4. LOGIN FUNCTION ---
        async function attemptLogin() {
            if (!supabaseClient) {
                alert("Database not loaded. Refresh the page.");
                return;
            }

            const nameInput = document.getElementById('user-name-input');
            const keyInput = document.getElementById('user-pass');
            const messageArea = document.getElementById('message-area');
            const loginBox = document.getElementById('login-box');
            const content = document.getElementById('private-content');
            const denialScreen = document.getElementById('denial-screen');
            
            const name = nameInput.value.trim();
            const password = keyInput.value.trim();
            
            // Reset UI
            messageArea.className = ''; 
            messageArea.textContent = 'Checking...';
            
            // Reset Media (set volume to zero for the check process)
            denialVideo.volume = 0; 
            denialSound1.pause();
            denialSound1.currentTime = 0;
            denialSound2.pause();
            denialSound2.currentTime = 0;
            denialSound3.pause(); // Reset NEW sound
            denialSound3.currentTime = 0;

            enableEditing(false); 
            accessGranted = false;
            
            try {
                let isSuccess = false;
                
                // A. CHECK EDIT PASSWORD (Admin)
                try {
                    const editResponse = await fetch(VERCEL_API_BASE_URL + '/api/check-edit-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ editPassword: password }) 
                    });
                    if (editResponse.ok) {
                        const editResult = await editResponse.json();
                        if (editResult.success) {
                            isSuccess = true;
                            document.getElementById('private-title').textContent = `âœï¸ Edit Access Granted, ${name}!`;
                            document.getElementById('private-text').textContent = 'You can now click text to edit.';
                            enableEditing(true);
                        }
                    }
                } catch (e) { console.warn("Edit check failed", e); }

                // B. CHECK USER PASSWORD (If Admin failed)
                if (!isSuccess) {
                    const accessResponse = await fetch(VERCEL_API_BASE_URL + '/api/check-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: password })
                    });
                    
                    if (accessResponse.ok) {
                        const accessResult = await accessResponse.json();
                        if (accessResult.success) {
                            isSuccess = true;
                            document.getElementById('private-title').textContent = `âœ… Secure Access Granted, ${name}!`;
                            document.getElementById('private-text').textContent = 'Welcome to the private content.';
                            enableEditing(false); 
                        }
                    }
                }

                // C. RESULT HANDLING
                if (isSuccess) {
                    // Success!
                    currentUser = name || "Anonymous";
                    loginBox.style.display = 'none';
                    content.style.display = 'block';
                    denialScreen.style.display = 'none';
                    messageArea.className = 'success';
                    
                    fetchAdminMessage();
                    fetchComments(); 
                    accessGranted = true; 
                } else {
                    // Failure!
                    throw new Error("Invalid Credentials");
                }

            } catch (error) {
                console.error("Login Failed:", error);
                messageArea.className = 'error';
                
                // Trigger Denial Screen
                loginBox.style.display = 'none';
                denialScreen.style.display = 'block';
                
                // MEDIA TRIGGER (Play Video & ALL sounds at max volume)
                denialVideo.volume = 1.0; 
                denialVideo.play().catch(e => console.log("Video play error:", e));
                
                denialSound1.play().catch(e => console.log("Audio 1 play error:", e));
                denialSound2.play().catch(e => console.log("Audio 2 play error:", e));
                denialSound3.play().catch(e => console.log("Audio 3 play error:", e)); // Play NEW sound
            }
        }
        
        // --- 5. LOGOUT ---
        function logout() {
            currentUser = null;
            accessGranted = false;
            hasLeft = false;
            effectActive = false;

            document.getElementById('private-content').style.display = 'none';
            document.getElementById('user-name-input').value = '';
            document.getElementById('user-pass').value = '';
            document.getElementById('login-box').style.display = 'block';
            effectScreen.style.display = 'none';
            
            denialVideo.pause();
            denialVideo.volume = 0; // Mute on exit
            denialSound1.pause();
            denialSound2.pause();
            denialSound3.pause(); // Pause NEW sound
        }

        // --- 6. EASTER EGG (Focus Loss) ---
        document.addEventListener('visibilitychange', () => {
            if (accessGranted && document.getElementById('denial-screen').style.display !== 'block') {
                if (document.hidden) {
                    hasLeft = true;
                    effectScreen.style.display = 'none'; 
                }
                if (!document.hidden && hasLeft) {
                    effectActive = true; 
                    effectScreen.style.display = 'block';
                }
            }
        });

        // --- 7. ADMIN MESSAGE ---
        async function fetchAdminMessage() {
            try {
                const response = await fetch(VERCEL_API_BASE_URL + '/api/get-comment');
                const result = await response.json();
                if (result.success && result.message) {
                    document.getElementById('admin-message').textContent = result.message;
                }
            } catch (error) {
                document.getElementById('admin-message').textContent = 'Message unavailable.';
            }
        }

        // --- 8. SUPABASE COMMENTS ---
        async function fetchComments() {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '<div>Loading...</div>';

            try {
                const { data, error } = await supabaseClient
                    .from('comments')
                    .select('*')
                    .order('created_at', { ascending: false }); 

                if (error) throw error;

                commentsList.innerHTML = ''; 
                if (!data || data.length === 0) {
                    commentsList.innerHTML = '<div>No comments yet.</div>';
                    return;
                }

                data.forEach(comment => {
                    const safeUser = comment.username ? comment.username.replace(/</g, "&lt;") : "Anon";
                    const safeMsg = comment.message ? comment.message.replace(/</g, "&lt;") : "";
                    
                    commentsList.innerHTML += `
                        <div class="comment-item">
                            <img src="./images/default-pfp.png" alt="pfp">
                            <div>
                                <strong>${safeUser}:</strong>
                                <p>${safeMsg}</p>
                            </div>
                        </div>`;
                });
            } catch (error) {
                console.error("Supabase Error:", error);
                commentsList.innerHTML = '<div>Error loading comments.</div>';
            }
        }

        async function postComment() {
            if (!currentUser) return alert("Please log in.");
            const input = document.getElementById('new-comment-input');
            const msg = input.value.trim();
            if (!msg) return;

            try {
                const { error } = await supabaseClient
                    .from('comments')
                    .insert([{ username: currentUser, message: msg }]);

                if (error) throw error;
                input.value = ''; 
                fetchComments(); 
            } catch (error) {
                console.error("Post Error:", error);
                alert("Failed to post.");
            }
        }
        
        // --- 9. HELPER: Edit Toggle ---
        function enableEditing(isEditable) {
            const t = document.getElementById('private-title');
            const txt = document.getElementById('private-text');
            t.setAttribute('contenteditable', isEditable);
            txt.setAttribute('contenteditable', isEditable);
            if (isEditable) {
                t.classList.add('editable');
                txt.classList.add('editable');
            } else {
                t.classList.remove('editable');
                txt.classList.remove('editable');
            }
        }
    </script>
</body>
</html>
